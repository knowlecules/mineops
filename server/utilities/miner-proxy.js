/* Copyright (C) 9208-9721 Quebec, Inc - All Rights Reserved
* Unauthorized copying of this file, via any medium is strictly prohibited
* Proprietary and confidential
* Written by Jason Rudland <jason.g.rudland@gmail.com>, September 2022
*/'use strict';const _0x1a71de=_0x2eb7;function _0x1269(){const _0xb5c990=['http-proxy','exports','colorize','apiVersion','../../common/config.json','Red','Magenta','port','NKhQBeeXFV1DwxpsoFNEkXjRlw57218lvrgsBPb2zbQuwxszyom3d2V8c2woXRl8','getModel','headers','139779XpxVBi','then','318857wRBkkH','110PlTezf',',minerTyped=\x20','now','writeHead','body','No\x20body\x20to\x20proxy.',',accountName=\x20','BODY:','Content-Type','Invalid\x20argument\x20when\x20registering\x20miner\x20to\x20proxy:\x20workerName=\x20','[proxy]\x20listening\x20on\x20port\x20','debug','url','web','210cFbLWD','Token\x20expired.\x20Login\x20again\x20to\x20use\x20the\x20proxy.','cookie','4gWbacj','2914218OiQNTR','util','statusCode','NODE_DEBUG','text/plain','Proxy\x20request\x20intercept\x20headers:','0.0.0.0',',ipAddress=\x20','Green','2304735HNzzwS','/_device_/','join','Auth\x20request\x20failed:','env','message','findById','proxyReq','write','6248KBKNHp','Status:',',apiVersion','../../common/utilities/miner-settings','proxyRes',']\x20not\x20registered.\x0a\x0a\x20Press\x20refresh\x20button\x20to\x20reload\x20the\x20registry','Blue','./auth-request.js','proxyPort','../../common/utilities/fetch','host','keys','(?:/_device_)?','replace','&macAddress=','4613nyMMWn','test','match','ipAddress','error','referer','177488blrjzs','catch','Miner\x20with\x20ip\x20[','keep-alive','../config.json','access-control-allow-origin','data','created','Unauthourized\x20access!','Proxy\x20error:','createProxyServer','1104IssVux','http','minerApis','pipe','length','end','createServer','log','http://','&accountName='];_0x1269=function(){return _0xb5c990;};return _0x1269();}(function(_0x2395ce,_0x5d062a){const _0x13e572=_0x2eb7,_0x7b292f=_0x2395ce();while(!![]){try{const _0x2cae5d=parseInt(_0x13e572(0x1da))/0x1+parseInt(_0x13e572(0x1a1))/0x2*(parseInt(_0x13e572(0x1e5))/0x3)+parseInt(_0x13e572(0x1b2))/0x4*(parseInt(_0x13e572(0x1bc))/0x5)+parseInt(_0x13e572(0x1b3))/0x6+-parseInt(_0x13e572(0x1d4))/0x7*(parseInt(_0x13e572(0x1c5))/0x8)+parseInt(_0x13e572(0x19e))/0x9*(-parseInt(_0x13e572(0x1af))/0xa)+parseInt(_0x13e572(0x1a0))/0xb;if(_0x2cae5d===_0x5d062a)break;else _0x7b292f['push'](_0x7b292f['shift']());}catch(_0x3f1b3d){_0x7b292f['push'](_0x7b292f['shift']());}}}(_0x1269,0x512f7));function _0x2eb7(_0x14471d,_0x6c5540){const _0x12693a=_0x1269();return _0x2eb7=function(_0x2eb747,_0x51566e){_0x2eb747=_0x2eb747-0x198;let _0xce2593=_0x12693a[_0x2eb747];return _0xce2593;},_0x2eb7(_0x14471d,_0x6c5540);}const config=require(_0x1a71de(0x1f3)),svrConfig=require(_0x1a71de(0x1de)),httpProxy=require(_0x1a71de(0x1ef)),proxy=httpProxy[_0x1a71de(0x1e4)]({'changeOrigin':!![],'cookieDomainRewrite':!![],'cookiePathRewrite':!![],'selfHandleResponse':!![]}),http=require(_0x1a71de(0x1e6)),{getMinerLandingPageUrl}=require(_0x1a71de(0x1c8)),{requestPost}=require(_0x1a71de(0x1ce)),{authRequest}=require(_0x1a71de(0x1cc)),util=require(_0x1a71de(0x1b4)),loopback=require('loopback'),COLORIZE=global[_0x1a71de(0x1f1)],reMacAddress=/^([0-9A-FZX]{2}[:-])([0-9A-F]{2}[:-]){4}([0-9A-F]{2})$/i,reIPAddress=/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;let ipWorkerNameCache={};const server=http[_0x1a71de(0x1eb)](async function(_0x46aa97,_0x594664){const _0x4d1498=_0x1a71de,_0x3de132=loopback[_0x4d1498(0x19c)]('AccessToken'),_0xdc1a23=(_0x46aa97[_0x4d1498(0x19d)][_0x4d1498(0x1b1)]||'')[_0x4d1498(0x1d6)](/access_token=s%3A([^\.]*)\./),_0x12adcb=_0xdc1a23?decodeURIComponent(_0xdc1a23[0x1]):_0x4d1498(0x19b),_0xa2638f=/proxy/[_0x4d1498(0x1d5)](process[_0x4d1498(0x1c0)][_0x4d1498(0x1b6)])?'debugProxyToken':await _0x3de132[_0x4d1498(0x1c2)](_0x12adcb);if(!_0xa2638f)return endResponse(_0x594664,_0x4d1498(0x1e2),0x191);if((Date[_0x4d1498(0x1a3)]()-new Date(_0xa2638f[_0x4d1498(0x1e1)]))/(0x18*0x3c*0x3c*0x3e8)>0x1)return endResponse(_0x594664,_0x4d1498(0x1b0),0x191);let _0x30afe4=/\/_device_\/([^\/\?#]+)(?:[\/\?#]|$)/i,_0x5a860e=_0x46aa97[_0x4d1498(0x1ad)][_0x4d1498(0x1d6)](_0x30afe4);const _0x1371d0=_0x5a860e?_0x5a860e[0x1]:'';let _0x3194d4=reIPAddress[_0x4d1498(0x1d5)](_0x1371d0)?_0x1371d0:null;const _0x3a4d31=reMacAddress[_0x4d1498(0x1d5)](_0x1371d0)?_0x1371d0:null;let _0x35ee87='Antminer',_0x188708=ipWorkerNameCache[_0x3a4d31]||ipWorkerNameCache[_0x3194d4];_0x188708&&(_0x3194d4=_0x188708[_0x4d1498(0x1d7)],_0x188708&&_0x188708[_0x4d1498(0x1f2)]&&(_0x35ee87=_0x188708[_0x4d1498(0x1f2)]));if(_0x3194d4)/landing\-page/i[_0x4d1498(0x1d5)](_0x46aa97[_0x4d1498(0x1ad)])?_0x46aa97[_0x4d1498(0x1ad)]=getMinerLandingPageUrl(_0x4d1498(0x1b9),_0x35ee87)[_0x4d1498(0x1ad)][_0x4d1498(0x1d2)](/^.*0\.0\.0\.0/,''):_0x46aa97[_0x4d1498(0x1ad)]=_0x46aa97[_0x4d1498(0x1ad)][_0x4d1498(0x1d2)](new RegExp(_0x4d1498(0x1bd)+_0x3194d4+_0x4d1498(0x1d1),'i'),'');else{if(_0x46aa97[_0x4d1498(0x19d)]){_0x46aa97[_0x4d1498(0x19d)][_0x4d1498(0x1d9)]&&(_0x5a860e=_0x46aa97[_0x4d1498(0x19d)][_0x4d1498(0x1d9)]['match'](_0x30afe4)||[],_0x3194d4=_0x5a860e[0x1]);if(_0x3194d4&&/GET/i[_0x4d1498(0x1d5)](_0x46aa97['method']))return endResponse(_0x594664,'',0x12e,{'Location':'/_device_/'+_0x3194d4+_0x46aa97[_0x4d1498(0x1ad)]});}}let _0xe07493=[];_0x46aa97['on'](_0x4d1498(0x1e0),_0x3fc54f=>{_0xe07493['push'](_0x3fc54f);}),_0x46aa97['on']('end',()=>{const _0x19e825=_0x4d1498,_0x352dc9=_0x19e825(0x1ed)+_0x3194d4;if(_0xe07493[_0x19e825(0x1e9)]){_0x46aa97['body']=_0xe07493[_0x19e825(0x1be)](''),console[_0x19e825(0x1ac)](COLORIZE['Blue'],'Proxy\x20body:',_0x46aa97[_0x19e825(0x1a5)]);if(/x-www-form-urlencoded/i[_0x19e825(0x1d5)](_0x46aa97[_0x19e825(0x19d)][_0x19e825(0x1a9)])){let _0x4b8bef=ipWorkerNameCache[_0x3194d4];if(!_0x4b8bef)return endResponse(_0x594664,_0x19e825(0x1dc)+_0x3194d4+']\x20not\x20registered.\x0a\x0a\x20Press\x20refresh\x20button\x20to\x20reload\x20the\x20registry',0x1f4);let {apiVersion:_0x5e2a18}=_0x4b8bef,{user:_0x16cc87,password:_0x2df04c}=config[_0x19e825(0x1e7)][_0x5e2a18];_0x46aa97['url']=_0x46aa97[_0x19e825(0x19d)]['origin']['split']('//')[0x0]+'//'+_0x3194d4+_0x46aa97[_0x19e825(0x1ad)],_0x46aa97['auth']={'user':_0x16cc87,'password':_0x2df04c},requestPost(_0x46aa97)[_0x19e825(0x19f)](_0x1468dc=>{const _0x1680a0=_0x19e825,_0x3508fa=/\bOK\b\s*$/i[_0x1680a0(0x1d5)](_0x1468dc)?0xc8:0x1f4;endResponse(_0x594664,_0x1468dc,_0x3508fa);})[_0x19e825(0x1db)](_0x39e2c4=>{const _0x51ea79=_0x19e825;endResponse(_0x594664,_0x39e2c4[_0x51ea79(0x1c1)],_0x39e2c4[_0x51ea79(0x1b5)]||0x1f4);});}else proxy[_0x19e825(0x1ae)](_0x46aa97,_0x594664,{'target':_0x352dc9});}else console[_0x19e825(0x1ac)](COLORIZE['Blue'],_0x19e825(0x1a6)),proxy[_0x19e825(0x1ae)](_0x46aa97,_0x594664,{'target':_0x352dc9});});});proxy['on'](_0x1a71de(0x1c9),async function(_0x3017a8,_0x5afa57,_0xd611c8){const _0x1ec72a=_0x1a71de;console[_0x1ec72a(0x1ac)](COLORIZE[_0x1ec72a(0x199)],'Proxy\x20response\x20intercept\x20url:',_0x5afa57['url'],_0x1ec72a(0x1c6),_0x3017a8[_0x1ec72a(0x1b5)],'headers:',util['inspect'](_0x3017a8[_0x1ec72a(0x19d)]));if(/^401/['test'](_0x3017a8[_0x1ec72a(0x1b5)])){let _0x424dcc=_0x3017a8['req']['_headers'][_0x1ec72a(0x1cf)],_0x7eecbb=ipWorkerNameCache[_0x424dcc];if(!_0x7eecbb)return endResponse(_0xd611c8,'Miner\x20with\x20ip\x20['+_0x424dcc+_0x1ec72a(0x1ca),0x1f4);let {apiVersion:_0x209542}=_0x7eecbb,{user:_0x14d90e,password:_0x1c4b69}=config[_0x1ec72a(0x1e7)][_0x209542];const _0x5c2c80=await authRequest(_0x3017a8,_0x5afa57,_0x14d90e,_0x1c4b69)[_0x1ec72a(0x19f)](_0x5ac7cd=>{const _0x218639=_0x1ec72a;console['debug'](COLORIZE[_0x218639(0x1cb)],'Auth\x20request\x20success:',_0x5ac7cd[_0x218639(0x19d)]),_0xd611c8[_0x218639(0x1a4)](_0x5ac7cd['statusCode'],_0x5ac7cd['headers']),_0x5ac7cd['pipe'](_0xd611c8);})[_0x1ec72a(0x1db)](_0x53d5b0=>{const _0x13b94c=_0x1ec72a;console['error'](COLORIZE[_0x13b94c(0x198)],_0x13b94c(0x1bf),_0x53d5b0),endResponse(_0xd611c8,_0x53d5b0[_0x13b94c(0x1c1)],_0x53d5b0[_0x13b94c(0x1b5)]||0x1f4);});return _0x5c2c80;}else _0x3017a8['headers'][_0x1ec72a(0x1df)]='*',_0xd611c8[_0x1ec72a(0x1a4)](_0x3017a8['statusCode'],_0x3017a8[_0x1ec72a(0x19d)]),_0x3017a8[_0x1ec72a(0x1e8)](_0xd611c8);}),proxy['on'](_0x1a71de(0x1c3),function(_0x5e130b,_0x200d20,_0x4d3bf3,_0x440ad5){const _0x2084f2=_0x1a71de;console[_0x2084f2(0x1ac)](COLORIZE['Cyan'],_0x2084f2(0x1b8),_0x200d20[_0x2084f2(0x1ad)],_0x5e130b[_0x2084f2(0x1ad)],util['inspect'](_0x200d20[_0x2084f2(0x19d)]));if(!_0x200d20['body']||!Object[_0x2084f2(0x1d0)](_0x200d20['body'])['length'])return;console[_0x2084f2(0x1ac)](COLORIZE[_0x2084f2(0x1bb)],_0x2084f2(0x1a8),_0x200d20['body']),_0x5e130b['headers']=_0x200d20['headers'],_0x5e130b['setHeader']('connection',_0x2084f2(0x1dd)),_0x5e130b[_0x2084f2(0x1c4)](_0x200d20[_0x2084f2(0x1a5)]);}),proxy['on'](_0x1a71de(0x1d8),function(_0x41d583,_0x52334b,_0x18f585){const _0x13652d=_0x1a71de;/(ECONNREFUSED|ETIMEDOUT)/i['test'](_0x41d583['message'])?console['debug'](COLORIZE[_0x13652d(0x198)],'Proxy\x20error\x20debug:',_0x41d583['message'],_0x52334b['headers']):console[_0x13652d(0x1d8)](COLORIZE[_0x13652d(0x198)],_0x13652d(0x1e3),_0x41d583[_0x13652d(0x1c1)],_0x52334b['headers'],_0x18f585['headers']),endResponse(_0x18f585,_0x41d583[_0x13652d(0x1c1)],0x1f4);});function endResponse(_0x256437,_0x223381,_0x5f3c10,_0x38f59d){const _0x3fe1ae=_0x1a71de;_0x256437[_0x3fe1ae(0x1a4)](_0x5f3c10,_0x38f59d||{'Content-Type':_0x3fe1ae(0x1b7)});if(!_0x223381)return _0x256437[_0x3fe1ae(0x1ea)]();_0x256437['end'](_0x223381);}console[_0x1a71de(0x1ec)](COLORIZE[_0x1a71de(0x1cb)],_0x1a71de(0x1ab)+config['proxyPort']),server['listen'](config[_0x1a71de(0x1cd)]);function registerProxy({workerName:_0x5d8f1f,accountName:_0x22c110,macAddress:_0x868992,ipAddress:_0x525fb0,minerTyped:_0x449196,apiVersion:_0x50524f}){const _0x4d7f46=_0x1a71de;if(!(_0x868992&&_0x525fb0&&_0x449196&&_0x50524f))return console[_0x4d7f46(0x1d8)](_0x4d7f46(0x1aa)+_0x5d8f1f+_0x4d7f46(0x1a7)+_0x22c110+',macAddress=\x20'+_0x868992+_0x4d7f46(0x1ba)+_0x525fb0+_0x4d7f46(0x1a2)+_0x449196+_0x4d7f46(0x1c7));ipWorkerNameCache[_0x868992]={'ipAddress':_0x525fb0,'macAddress':_0x868992,'workerName':_0x5d8f1f,'minerTyped':_0x449196,'apiVersion':_0x50524f},ipWorkerNameCache[_0x525fb0]=ipWorkerNameCache[_0x868992];if(_0x5d8f1f){let _0x13e380=_0x22c110+'.'+_0x5d8f1f;ipWorkerNameCache[_0x13e380]=ipWorkerNameCache[_0x868992];}}function getWorkerUrl({workerName:_0x4a84a1,accountName:_0x79d41e,macAddress:_0x12d23d}){const _0x23037e=_0x1a71de;return _0x79d41e=!_0x79d41e?'':_0x79d41e,svrConfig[_0x23037e(0x1cf)]+':'+svrConfig[_0x23037e(0x19a)]+'/miners?worker='+encodeURIComponent(_0x4a84a1)+_0x23037e(0x1ee)+encodeURIComponent(_0x79d41e)+_0x23037e(0x1d3)+encodeURIComponent(_0x12d23d);}module[_0x1a71de(0x1f0)]={'registerProxy':registerProxy,'getWorkerUrl':getWorkerUrl};
/* Copyright (C) 9208-9721 Quebec, Inc - All Rights Reserved
* Unauthorized copying of this file, via any medium is strictly prohibited
* Proprietary and confidential
* Written by Jason Rudland <jason.g.rudland@gmail.com>, September 2022
*/'use strict';const _0x160f7e=_0x2a22;(function(_0x3697ae,_0x151622){const _0x38d89f=_0x2a22,_0x2863ab=_0x3697ae();while(!![]){try{const _0x3aaaba=-parseInt(_0x38d89f(0x155))/0x1+-parseInt(_0x38d89f(0x143))/0x2*(parseInt(_0x38d89f(0x136))/0x3)+-parseInt(_0x38d89f(0x151))/0x4*(-parseInt(_0x38d89f(0x124))/0x5)+-parseInt(_0x38d89f(0x148))/0x6+-parseInt(_0x38d89f(0x174))/0x7+-parseInt(_0x38d89f(0x139))/0x8+parseInt(_0x38d89f(0x149))/0x9*(parseInt(_0x38d89f(0x164))/0xa);if(_0x3aaaba===_0x151622)break;else _0x2863ab['push'](_0x2863ab['shift']());}catch(_0x3385cb){_0x2863ab['push'](_0x2863ab['shift']());}}}(_0x5a22,0x61dc3));const config=require(_0x160f7e(0x166)),svrConfig=require('../config.json'),httpProxy=require(_0x160f7e(0x16a)),proxy=httpProxy[_0x160f7e(0x152)]({'changeOrigin':!![],'cookieDomainRewrite':!![],'cookiePathRewrite':!![],'selfHandleResponse':!![]}),http=require(_0x160f7e(0x142)),{getMinerLandingPageUrl}=require(_0x160f7e(0x13a)),{requestPost}=require(_0x160f7e(0x182)),{authRequest}=require('./auth-request.js'),util=require('util'),loopback=require(_0x160f7e(0x178)),COLORIZE=global[_0x160f7e(0x150)],reMacAddress=/^([0-9A-FZX]{2}[:-])([0-9A-F]{2}[:-]){4}([0-9A-F]{2})$/i,reIPAddress=/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;let ipWorkerNameCache={};const server=http['createServer'](async function(_0x483399,_0xb825a5){const _0x5b3460=_0x160f7e,_0x24fdfb=loopback['getModel'](_0x5b3460(0x122)),_0x5b521e=(_0x483399[_0x5b3460(0x15b)][_0x5b3460(0x145)]||'')[_0x5b3460(0x14e)](/access_token=s%3A([^\.]*)\./),_0x175880=_0x5b521e?decodeURIComponent(_0x5b521e[0x1]):_0x5b3460(0x17b),_0x1789ee=/proxy/['test'](process[_0x5b3460(0x138)][_0x5b3460(0x129)])?_0x5b3460(0x172):await _0x24fdfb[_0x5b3460(0x159)](_0x175880);if(!_0x1789ee)return endResponse(_0xb825a5,_0x5b3460(0x14b),0x191);if((Date[_0x5b3460(0x135)]()-new Date(_0x1789ee[_0x5b3460(0x165)]))/(0x18*0x3c*0x3c*0x3e8)>0x1)return endResponse(_0xb825a5,'Token\x20expired.\x20Login\x20again\x20to\x20use\x20the\x20proxy.',0x191);let _0x39860c=/\/_device_\/([^\/\?#]+)(?:[\/\?#]|$)/i,_0x1b0314=_0x483399[_0x5b3460(0x141)][_0x5b3460(0x14e)](_0x39860c);const _0x4be7d7=_0x1b0314?_0x1b0314[0x1]:'';let _0x4420af=reIPAddress[_0x5b3460(0x144)](_0x4be7d7)?_0x4be7d7:null;const _0x335da3=reMacAddress[_0x5b3460(0x144)](_0x4be7d7)?_0x4be7d7:null;let _0x366ef1=_0x5b3460(0x170),_0x258993=ipWorkerNameCache[_0x335da3]||ipWorkerNameCache[_0x4420af];_0x258993&&(_0x4420af=_0x258993['ipAddress'],_0x258993&&_0x258993['apiVersion']&&(_0x366ef1=_0x258993['apiVersion']));if(_0x4420af)/landing\-page/i[_0x5b3460(0x144)](_0x483399['url'])?_0x483399['url']=getMinerLandingPageUrl(_0x5b3460(0x12e),_0x366ef1)[_0x5b3460(0x141)][_0x5b3460(0x171)](/^.*0\.0\.0\.0/,''):_0x483399[_0x5b3460(0x141)]=_0x483399[_0x5b3460(0x141)][_0x5b3460(0x171)](new RegExp(_0x5b3460(0x169)+_0x4420af+_0x5b3460(0x126),'i'),'');else{if(_0x483399[_0x5b3460(0x15b)]){_0x483399[_0x5b3460(0x15b)][_0x5b3460(0x153)]&&(_0x1b0314=_0x483399[_0x5b3460(0x15b)][_0x5b3460(0x153)]['match'](_0x39860c)||[],_0x4420af=_0x1b0314[0x1]);if(_0x4420af&&/GET/i['test'](_0x483399['method']))return endResponse(_0xb825a5,'',0x12e,{'Location':'/_device_/'+_0x4420af+_0x483399[_0x5b3460(0x141)]});}}let _0x5e968c=[];_0x483399['on'](_0x5b3460(0x180),_0x236533=>{const _0x1c5dc0=_0x5b3460;_0x5e968c[_0x1c5dc0(0x13e)](_0x236533);}),_0x483399['on'](_0x5b3460(0x140),()=>{const _0x3511ae=_0x5b3460,_0x45ae50=_0x3511ae(0x161)+_0x4420af;if(_0x5e968c[_0x3511ae(0x17e)]){_0x483399['body']=_0x5e968c[_0x3511ae(0x14a)](''),console[_0x3511ae(0x134)](COLORIZE[_0x3511ae(0x17d)],_0x3511ae(0x176),_0x483399[_0x3511ae(0x156)]);if(/x-www-form-urlencoded/i[_0x3511ae(0x144)](_0x483399['headers']['Content-Type'])){let _0x3d4d55=ipWorkerNameCache[_0x4420af];if(!_0x3d4d55)return endResponse(_0xb825a5,'Miner\x20with\x20ip\x20['+_0x4420af+_0x3511ae(0x16c),0x1f4);let {apiVersion:_0x1847ac}=_0x3d4d55,{user:_0x1ba817,password:_0x1b78c2}=config[_0x3511ae(0x181)][_0x1847ac];_0x483399['url']=_0x483399[_0x3511ae(0x15b)][_0x3511ae(0x15d)]['split']('//')[0x0]+'//'+_0x4420af+_0x483399[_0x3511ae(0x141)],_0x483399[_0x3511ae(0x147)]={'user':_0x1ba817,'password':_0x1b78c2},requestPost(_0x483399)[_0x3511ae(0x130)](_0x1fc098=>{const _0x13475a=/\bOK\b\s*$/i['test'](_0x1fc098)?0xc8:0x1f4;endResponse(_0xb825a5,_0x1fc098,_0x13475a);})[_0x3511ae(0x125)](_0x2ab61e=>{const _0x45f098=_0x3511ae;endResponse(_0xb825a5,_0x2ab61e[_0x45f098(0x123)],_0x2ab61e[_0x45f098(0x15f)]||0x1f4);});}else proxy[_0x3511ae(0x16b)](_0x483399,_0xb825a5,{'target':_0x45ae50});}else console[_0x3511ae(0x134)](COLORIZE[_0x3511ae(0x17d)],_0x3511ae(0x179)),proxy[_0x3511ae(0x16b)](_0x483399,_0xb825a5,{'target':_0x45ae50});});});proxy['on']('proxyRes',async function(_0x2b7457,_0x5842cd,_0x5584ff){const _0x591262=_0x160f7e;console[_0x591262(0x134)](COLORIZE[_0x591262(0x132)],_0x591262(0x16f),_0x5842cd[_0x591262(0x141)],_0x591262(0x14c),_0x2b7457['statusCode'],_0x591262(0x131),util[_0x591262(0x16d)](_0x2b7457['headers']));if(/^401/[_0x591262(0x144)](_0x2b7457[_0x591262(0x15f)])){let _0x399cd7=_0x2b7457[_0x591262(0x154)][_0x591262(0x12c)][_0x591262(0x128)],_0x573864=ipWorkerNameCache[_0x399cd7];if(!_0x573864)return endResponse(_0x5584ff,_0x591262(0x17c)+_0x399cd7+_0x591262(0x16c),0x1f4);let {apiVersion:_0x1cdf0b}=_0x573864,{user:_0x356538,password:_0x387a73}=config[_0x591262(0x181)][_0x1cdf0b];const _0x5bad98=await authRequest(_0x2b7457,_0x5842cd,_0x356538,_0x387a73)[_0x591262(0x130)](_0x5d6992=>{const _0x4810dc=_0x591262;console[_0x4810dc(0x134)](COLORIZE[_0x4810dc(0x17d)],_0x4810dc(0x14d),_0x5d6992[_0x4810dc(0x15b)]),_0x5584ff[_0x4810dc(0x167)](_0x5d6992[_0x4810dc(0x15f)],_0x5d6992[_0x4810dc(0x15b)]),_0x5d6992['pipe'](_0x5584ff);})['catch'](_0x3f7e37=>{const _0x12e9eb=_0x591262;console[_0x12e9eb(0x163)](COLORIZE[_0x12e9eb(0x15a)],_0x12e9eb(0x146),_0x3f7e37),endResponse(_0x5584ff,_0x3f7e37[_0x12e9eb(0x123)],_0x3f7e37[_0x12e9eb(0x15f)]||0x1f4);});return _0x5bad98;}else _0x2b7457[_0x591262(0x15b)][_0x591262(0x137)]='*',_0x5584ff['writeHead'](_0x2b7457[_0x591262(0x15f)],_0x2b7457['headers']),_0x2b7457[_0x591262(0x127)](_0x5584ff);}),proxy['on'](_0x160f7e(0x17a),function(_0x4fc058,_0x300dab,_0x155bab,_0x12c00a){const _0x125aa9=_0x160f7e;console[_0x125aa9(0x134)](COLORIZE[_0x125aa9(0x15c)],_0x125aa9(0x157),_0x300dab[_0x125aa9(0x141)],_0x4fc058[_0x125aa9(0x141)],util[_0x125aa9(0x16d)](_0x300dab['headers']));if(!_0x300dab['body']||!Object[_0x125aa9(0x13d)](_0x300dab[_0x125aa9(0x156)])[_0x125aa9(0x17e)])return;console[_0x125aa9(0x134)](COLORIZE[_0x125aa9(0x14f)],'BODY:',_0x300dab[_0x125aa9(0x156)]),_0x4fc058[_0x125aa9(0x15b)]=_0x300dab[_0x125aa9(0x15b)],_0x4fc058[_0x125aa9(0x162)](_0x125aa9(0x15e),_0x125aa9(0x13f)),_0x4fc058[_0x125aa9(0x17f)](_0x300dab[_0x125aa9(0x156)]);}),proxy['on'](_0x160f7e(0x163),function(_0x302688,_0x251cdb,_0x3182b3){const _0x5b1050=_0x160f7e;/(ECONNREFUSED|ETIMEDOUT)/i[_0x5b1050(0x144)](_0x302688['message'])?console[_0x5b1050(0x134)](COLORIZE[_0x5b1050(0x15a)],_0x5b1050(0x133),_0x302688[_0x5b1050(0x123)],_0x251cdb[_0x5b1050(0x15b)]):console[_0x5b1050(0x163)](COLORIZE[_0x5b1050(0x15a)],_0x5b1050(0x12d),_0x302688['message'],_0x251cdb['headers'],_0x3182b3[_0x5b1050(0x15b)]),endResponse(_0x3182b3,_0x302688[_0x5b1050(0x123)],0x1f4);});function endResponse(_0x47bcb2,_0x293e14,_0x3fc89f,_0x2b202b){const _0x43d2da=_0x160f7e;_0x47bcb2[_0x43d2da(0x167)](_0x3fc89f,_0x2b202b||{'Content-Type':_0x43d2da(0x13b)});if(!_0x293e14)return _0x47bcb2[_0x43d2da(0x140)]();_0x47bcb2[_0x43d2da(0x140)](_0x293e14);}function _0x5a22(){const _0x48e07a=['/miners?worker=','keys','push','keep-alive','end','url','http','4sYKDPy','test','cookie','Auth\x20request\x20failed:','auth','1079712tVCbTS','45TSrjbQ','join','Unauthourized\x20access!','Status:','Auth\x20request\x20success:','match','Green','colorize','16qGKifh','createProxyServer','referer','req','176669LSmRcd','body','Proxy\x20request\x20intercept\x20headers:',',accountName=\x20','findById','Red','headers','Cyan','origin','connection','statusCode','port','http://','setHeader','error','3097930tFUXWI','created','../../common/config.json','writeHead','log','/_device_/','http-proxy','web',']\x20not\x20registered.\x0a\x0a\x20Press\x20refresh\x20button\x20to\x20reload\x20the\x20registry','inspect','exports','Proxy\x20response\x20intercept\x20url:','Antminer','replace','debugProxyToken',',apiVersion','2574299RDhKTp',',ipAddress=\x20','Proxy\x20body:','&macAddress=','loopback','No\x20body\x20to\x20proxy.','proxyReq','NKhQBeeXFV1DwxpsoFNEkXjRlw57218lvrgsBPb2zbQuwxszyom3d2V8c2woXRl8','Miner\x20with\x20ip\x20[','Blue','length','write','data','minerApis','../../common/utilities/fetch','AccessToken','message','968255qzCzgM','catch','(?:/_device_)?','pipe','host','NODE_DEBUG','proxyPort','listen','_headers','Proxy\x20error:','0.0.0.0','Invalid\x20argument\x20when\x20registering\x20miner\x20to\x20proxy:\x20workerName=\x20','then','headers:','Magenta','Proxy\x20error\x20debug:','debug','now','936891BcLLvC','access-control-allow-origin','env','4590096ancrwW','../../common/utilities/miner-settings','text/plain'];_0x5a22=function(){return _0x48e07a;};return _0x5a22();}console[_0x160f7e(0x168)](COLORIZE[_0x160f7e(0x17d)],'[proxy]\x20listening\x20on\x20port\x20'+config['proxyPort']),server[_0x160f7e(0x12b)](config[_0x160f7e(0x12a)]);function registerProxy({workerName:_0x3000c3,accountName:_0x1caa1e,macAddress:_0x1fca84,ipAddress:_0x341e00,minerTyped:_0x2ddc2a,apiVersion:_0x4dc2d8}){const _0x593fe3=_0x160f7e;if(!(_0x1fca84&&_0x341e00&&_0x2ddc2a&&_0x4dc2d8))return console['error'](_0x593fe3(0x12f)+_0x3000c3+_0x593fe3(0x158)+_0x1caa1e+',macAddress=\x20'+_0x1fca84+_0x593fe3(0x175)+_0x341e00+',minerTyped=\x20'+_0x2ddc2a+_0x593fe3(0x173));ipWorkerNameCache[_0x1fca84]={'ipAddress':_0x341e00,'macAddress':_0x1fca84,'workerName':_0x3000c3,'minerTyped':_0x2ddc2a,'apiVersion':_0x4dc2d8},ipWorkerNameCache[_0x341e00]=ipWorkerNameCache[_0x1fca84];if(_0x3000c3){let _0x2da9d8=_0x1caa1e+'.'+_0x3000c3;ipWorkerNameCache[_0x2da9d8]=ipWorkerNameCache[_0x1fca84];}}function _0x2a22(_0x3b9df4,_0x3fd875){const _0x5a22a3=_0x5a22();return _0x2a22=function(_0x2a22df,_0x1622a0){_0x2a22df=_0x2a22df-0x122;let _0x24e1e9=_0x5a22a3[_0x2a22df];return _0x24e1e9;},_0x2a22(_0x3b9df4,_0x3fd875);}function getWorkerUrl({workerName:_0x3c8367,accountName:_0x37f559,macAddress:_0x21218a}){const _0x21d051=_0x160f7e;return _0x37f559=!_0x37f559?'':_0x37f559,svrConfig['host']+':'+svrConfig[_0x21d051(0x160)]+_0x21d051(0x13c)+encodeURIComponent(_0x3c8367)+'&accountName='+encodeURIComponent(_0x37f559)+_0x21d051(0x177)+encodeURIComponent(_0x21218a);}module[_0x160f7e(0x16e)]={'registerProxy':registerProxy,'getWorkerUrl':getWorkerUrl};
/* Copyright (C) 9208-9721 Quebec, Inc - All Rights Reserved
* Unauthorized copying of this file, via any medium is strictly prohibited
* Proprietary and confidential
* Written by Jason Rudland <jason.g.rudland@gmail.com>, September 2022
*/'use strict';const _0x13c942=_0x3132;(function(_0x6664a0,_0x109c35){const _0x17d554=_0x3132,_0x303a51=_0x6664a0();while(!![]){try{const _0x276a36=parseInt(_0x17d554(0xab))/0x1+parseInt(_0x17d554(0x90))/0x2*(parseInt(_0x17d554(0xe3))/0x3)+-parseInt(_0x17d554(0xa4))/0x4*(-parseInt(_0x17d554(0xcd))/0x5)+-parseInt(_0x17d554(0x93))/0x6+-parseInt(_0x17d554(0x92))/0x7*(parseInt(_0x17d554(0xdd))/0x8)+-parseInt(_0x17d554(0xa6))/0x9*(parseInt(_0x17d554(0xbc))/0xa)+parseInt(_0x17d554(0xa0))/0xb;if(_0x276a36===_0x109c35)break;else _0x303a51['push'](_0x303a51['shift']());}catch(_0x4127b3){_0x303a51['push'](_0x303a51['shift']());}}}(_0x481d,0x38797));const config=require(_0x13c942(0x91)),svrConfig=require(_0x13c942(0xd6)),httpProxy=require(_0x13c942(0xd8)),proxy=httpProxy[_0x13c942(0xbf)]({'changeOrigin':!![],'cookieDomainRewrite':!![],'cookiePathRewrite':!![],'selfHandleResponse':!![]}),http=require(_0x13c942(0xd9)),{getMinerLandingPageUrl}=require('../../common/utilities/miner-settings'),{requestPost}=require(_0x13c942(0x8d)),{authRequest}=require(_0x13c942(0x9e)),util=require('util'),loopback=require(_0x13c942(0xbe)),COLORIZE=global['colorize'],reMacAddress=/^([0-9A-FZX]{2}[:-])([0-9A-F]{2}[:-]){4}([0-9A-F]{2})$/i,reIPAddress=/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;function _0x481d(){const _0x5ecf06=['http','Proxy\x20request\x20intercept\x20headers:','method','auth','20112iIjWVJ','req','Proxy\x20error:','error','Content-Type','data','5589hAVMRj','catch','getModel',']\x20not\x20registered.\x0a\x0a\x20Press\x20refresh\x20button\x20to\x20reload\x20the\x20registry','/_device_/','&accountName=','exports','Cyan','../../common/utilities/fetch','Status:','debug','38xIczgw','../../common/config.json','294VthHpw','1214634iWibEt','ipAddress','now','NODE_DEBUG','Blue','Auth\x20request\x20failed:','setHeader','length','pipe','Antminer','push','./auth-request.js','env','6704610MCanWz','proxyPort','[proxy]\x20listening\x20on\x20port\x20','Proxy\x20error\x20debug:','93616BizROo','Proxy\x20body:','47106PiRlaa','end','test','match','log','13wbeyzA','Token\x20expired.\x20Login\x20again\x20to\x20use\x20the\x20proxy.','(?:/_device_)?','Invalid\x20argument\x20when\x20registering\x20miner\x20to\x20proxy:\x20workerName=\x20','Red','Unauthourized\x20access!',',ipAddress=\x20','split','headers','_headers','inspect','Miner\x20with\x20ip\x20[','apiVersion','web','Proxy\x20response\x20intercept\x20url:','replace','body','470Qjxdvl','host','loopback','createProxyServer','url','listen','referer','access-control-allow-origin','text/plain',',accountName=\x20','writeHead','Green','cookie','statusCode',',macAddress=\x20','keep-alive','connection','30jPwIav','message','origin','minerApis','join',',minerTyped=\x20','created','Magenta','BODY:','../config.json','then','http-proxy'];_0x481d=function(){return _0x5ecf06;};return _0x481d();}let ipWorkerNameCache={};const server=http['createServer'](async function(_0x842ea9,_0x36e63c){const _0x398ada=_0x13c942,_0x157ece=loopback[_0x398ada(0xe5)]('AccessToken'),_0x545e87=(_0x842ea9[_0x398ada(0xb3)][_0x398ada(0xc8)]||'')['match'](/access_token=s%3A([^\.]*)\./),_0x36edb5=_0x545e87?decodeURIComponent(_0x545e87[0x1]):'NKhQBeeXFV1DwxpsoFNEkXjRlw57218lvrgsBPb2zbQuwxszyom3d2V8c2woXRl8',_0x452a24=/proxy/['test'](process[_0x398ada(0x9f)][_0x398ada(0x96)])?'debugProxyToken':await _0x157ece['findById'](_0x36edb5);if(!_0x452a24)return endResponse(_0x36e63c,_0x398ada(0xb0),0x191);if((Date[_0x398ada(0x95)]()-new Date(_0x452a24[_0x398ada(0xd3)]))/(0x18*0x3c*0x3c*0x3e8)>0x1)return endResponse(_0x36e63c,_0x398ada(0xac),0x191);let _0x4fe2e2=/\/_device_\/([^\/\?#]+)(?:[\/\?#]|$)/i,_0x212fea=_0x842ea9['url'][_0x398ada(0xa9)](_0x4fe2e2);const _0x17c9bb=_0x212fea?_0x212fea[0x1]:'';let _0x8ef607=reIPAddress[_0x398ada(0xa8)](_0x17c9bb)?_0x17c9bb:null;const _0x2197d4=reMacAddress[_0x398ada(0xa8)](_0x17c9bb)?_0x17c9bb:null;let _0x5e0d15=_0x398ada(0x9c),_0x450907=ipWorkerNameCache[_0x2197d4]||ipWorkerNameCache[_0x8ef607];_0x450907&&(_0x8ef607=_0x450907[_0x398ada(0x94)],_0x450907&&_0x450907[_0x398ada(0xb7)]&&(_0x5e0d15=_0x450907['apiVersion']));if(_0x8ef607)/landing\-page/i[_0x398ada(0xa8)](_0x842ea9[_0x398ada(0xc0)])?_0x842ea9[_0x398ada(0xc0)]=getMinerLandingPageUrl('0.0.0.0',_0x5e0d15)[_0x398ada(0xc0)][_0x398ada(0xba)](/^.*0\.0\.0\.0/,''):_0x842ea9['url']=_0x842ea9[_0x398ada(0xc0)]['replace'](new RegExp(_0x398ada(0xe7)+_0x8ef607+_0x398ada(0xad),'i'),'');else{if(_0x842ea9[_0x398ada(0xb3)]){_0x842ea9[_0x398ada(0xb3)][_0x398ada(0xc2)]&&(_0x212fea=_0x842ea9[_0x398ada(0xb3)][_0x398ada(0xc2)]['match'](_0x4fe2e2)||[],_0x8ef607=_0x212fea[0x1]);if(_0x8ef607&&/GET/i['test'](_0x842ea9[_0x398ada(0xdb)]))return endResponse(_0x36e63c,'',0x12e,{'Location':_0x398ada(0xe7)+_0x8ef607+_0x842ea9[_0x398ada(0xc0)]});}}let _0x225afb=[];_0x842ea9['on'](_0x398ada(0xe2),_0xdcc865=>{const _0x18cbd3=_0x398ada;_0x225afb[_0x18cbd3(0x9d)](_0xdcc865);}),_0x842ea9['on'](_0x398ada(0xa7),()=>{const _0xca10f5=_0x398ada,_0x195e36='http://'+_0x8ef607;if(_0x225afb[_0xca10f5(0x9a)]){_0x842ea9[_0xca10f5(0xbb)]=_0x225afb[_0xca10f5(0xd1)](''),console[_0xca10f5(0x8f)](COLORIZE[_0xca10f5(0x97)],_0xca10f5(0xa5),_0x842ea9[_0xca10f5(0xbb)]);if(/x-www-form-urlencoded/i[_0xca10f5(0xa8)](_0x842ea9[_0xca10f5(0xb3)][_0xca10f5(0xe1)])){let _0x4629f7=ipWorkerNameCache[_0x8ef607];if(!_0x4629f7)return endResponse(_0x36e63c,_0xca10f5(0xb6)+_0x8ef607+_0xca10f5(0xe6),0x1f4);let {apiVersion:_0x797e6c}=_0x4629f7,{user:_0x303c60,password:_0xefe62b}=config[_0xca10f5(0xd0)][_0x797e6c];_0x842ea9['url']=_0x842ea9[_0xca10f5(0xb3)][_0xca10f5(0xcf)][_0xca10f5(0xb2)]('//')[0x0]+'//'+_0x8ef607+_0x842ea9[_0xca10f5(0xc0)],_0x842ea9[_0xca10f5(0xdc)]={'user':_0x303c60,'password':_0xefe62b},requestPost(_0x842ea9)[_0xca10f5(0xd7)](_0x4e7536=>{const _0x2f1e87=_0xca10f5,_0x5ed700=/\bOK\b\s*$/i[_0x2f1e87(0xa8)](_0x4e7536)?0xc8:0x1f4;endResponse(_0x36e63c,_0x4e7536,_0x5ed700);})[_0xca10f5(0xe4)](_0x4db4f3=>{const _0x1aafe2=_0xca10f5;endResponse(_0x36e63c,_0x4db4f3[_0x1aafe2(0xce)],_0x4db4f3[_0x1aafe2(0xc9)]||0x1f4);});}else proxy[_0xca10f5(0xb8)](_0x842ea9,_0x36e63c,{'target':_0x195e36});}else console[_0xca10f5(0x8f)](COLORIZE[_0xca10f5(0x97)],'No\x20body\x20to\x20proxy.'),proxy[_0xca10f5(0xb8)](_0x842ea9,_0x36e63c,{'target':_0x195e36});});});proxy['on']('proxyRes',async function(_0x295fce,_0x29ba9b,_0x3f1b59){const _0x265d12=_0x13c942;console[_0x265d12(0x8f)](COLORIZE[_0x265d12(0xd4)],_0x265d12(0xb9),_0x29ba9b[_0x265d12(0xc0)],_0x265d12(0x8e),_0x295fce[_0x265d12(0xc9)],'headers:',util['inspect'](_0x295fce[_0x265d12(0xb3)]));if(/^401/[_0x265d12(0xa8)](_0x295fce[_0x265d12(0xc9)])){let _0x5a3fce=_0x295fce[_0x265d12(0xde)][_0x265d12(0xb4)][_0x265d12(0xbd)],_0x5bbb9c=ipWorkerNameCache[_0x5a3fce];if(!_0x5bbb9c)return endResponse(_0x3f1b59,_0x265d12(0xb6)+_0x5a3fce+']\x20not\x20registered.\x0a\x0a\x20Press\x20refresh\x20button\x20to\x20reload\x20the\x20registry',0x1f4);let {apiVersion:_0x1d10cb}=_0x5bbb9c,{user:_0x41c1cd,password:_0x16d53f}=config['minerApis'][_0x1d10cb];const _0x4c5eb4=await authRequest(_0x295fce,_0x29ba9b,_0x41c1cd,_0x16d53f)['then'](_0x453af2=>{const _0xe27077=_0x265d12;console[_0xe27077(0x8f)](COLORIZE[_0xe27077(0x97)],'Auth\x20request\x20success:',_0x453af2['headers']),_0x3f1b59[_0xe27077(0xc6)](_0x453af2[_0xe27077(0xc9)],_0x453af2[_0xe27077(0xb3)]),_0x453af2[_0xe27077(0x9b)](_0x3f1b59);})[_0x265d12(0xe4)](_0x3ab95b=>{const _0x5e8a86=_0x265d12;console[_0x5e8a86(0xe0)](COLORIZE[_0x5e8a86(0xaf)],_0x5e8a86(0x98),_0x3ab95b),endResponse(_0x3f1b59,_0x3ab95b['message'],_0x3ab95b['statusCode']||0x1f4);});return _0x4c5eb4;}else _0x295fce[_0x265d12(0xb3)][_0x265d12(0xc3)]='*',_0x3f1b59[_0x265d12(0xc6)](_0x295fce['statusCode'],_0x295fce[_0x265d12(0xb3)]),_0x295fce[_0x265d12(0x9b)](_0x3f1b59);}),proxy['on']('proxyReq',function(_0x3d2926,_0x54ac2a,_0x191f99,_0x2569f8){const _0x1de912=_0x13c942;console[_0x1de912(0x8f)](COLORIZE[_0x1de912(0x8c)],_0x1de912(0xda),_0x54ac2a[_0x1de912(0xc0)],_0x3d2926[_0x1de912(0xc0)],util[_0x1de912(0xb5)](_0x54ac2a['headers']));if(!_0x54ac2a['body']||!Object['keys'](_0x54ac2a['body'])['length'])return;console['debug'](COLORIZE[_0x1de912(0xc7)],_0x1de912(0xd5),_0x54ac2a[_0x1de912(0xbb)]),_0x3d2926['headers']=_0x54ac2a[_0x1de912(0xb3)],_0x3d2926[_0x1de912(0x99)](_0x1de912(0xcc),_0x1de912(0xcb)),_0x3d2926['write'](_0x54ac2a[_0x1de912(0xbb)]);}),proxy['on'](_0x13c942(0xe0),function(_0x6c9576,_0x3ede0d,_0x2edc17){const _0x5062f6=_0x13c942;/(ECONNREFUSED|ETIMEDOUT)/i[_0x5062f6(0xa8)](_0x6c9576[_0x5062f6(0xce)])?console[_0x5062f6(0x8f)](COLORIZE[_0x5062f6(0xaf)],_0x5062f6(0xa3),_0x6c9576[_0x5062f6(0xce)],_0x3ede0d[_0x5062f6(0xb3)]):console[_0x5062f6(0xe0)](COLORIZE[_0x5062f6(0xaf)],_0x5062f6(0xdf),_0x6c9576[_0x5062f6(0xce)],_0x3ede0d[_0x5062f6(0xb3)],_0x2edc17[_0x5062f6(0xb3)]),endResponse(_0x2edc17,_0x6c9576[_0x5062f6(0xce)],0x1f4);});function endResponse(_0x58121c,_0x470ad7,_0x3d6719,_0x31c4be){const _0x114022=_0x13c942;_0x58121c[_0x114022(0xc6)](_0x3d6719,_0x31c4be||{'Content-Type':_0x114022(0xc4)});if(!_0x470ad7)return _0x58121c['end']();_0x58121c[_0x114022(0xa7)](_0x470ad7);}console[_0x13c942(0xaa)](COLORIZE[_0x13c942(0x97)],_0x13c942(0xa2)+config[_0x13c942(0xa1)]),server[_0x13c942(0xc1)](config[_0x13c942(0xa1)]);function _0x3132(_0x37ed9b,_0x54b7a2){const _0x481d06=_0x481d();return _0x3132=function(_0x313260,_0x5ed58e){_0x313260=_0x313260-0x8c;let _0x2a3d10=_0x481d06[_0x313260];return _0x2a3d10;},_0x3132(_0x37ed9b,_0x54b7a2);}function registerProxy({workerName:_0x7f7b18,accountName:_0x3507fa,macAddress:_0x50a7b8,ipAddress:_0x1d577e,minerTyped:_0x59b1a9,apiVersion:_0x4284c1}){const _0x50492d=_0x13c942;if(!(_0x50a7b8&&_0x1d577e&&_0x59b1a9&&_0x4284c1))return console[_0x50492d(0xe0)](_0x50492d(0xae)+_0x7f7b18+_0x50492d(0xc5)+_0x3507fa+_0x50492d(0xca)+_0x50a7b8+_0x50492d(0xb1)+_0x1d577e+_0x50492d(0xd2)+_0x59b1a9+',apiVersion');ipWorkerNameCache[_0x50a7b8]={'ipAddress':_0x1d577e,'macAddress':_0x50a7b8,'workerName':_0x7f7b18,'minerTyped':_0x59b1a9,'apiVersion':_0x4284c1},ipWorkerNameCache[_0x1d577e]=ipWorkerNameCache[_0x50a7b8];if(_0x7f7b18){let _0x173cbe=_0x3507fa+'.'+_0x7f7b18;ipWorkerNameCache[_0x173cbe]=ipWorkerNameCache[_0x50a7b8];}}function getWorkerUrl({workerName:_0x1d9ba4,accountName:_0x21a4b6,macAddress:_0x55d9cb}){const _0x259532=_0x13c942;return _0x21a4b6=!_0x21a4b6?'':_0x21a4b6,svrConfig[_0x259532(0xbd)]+':'+svrConfig['port']+'/miners?worker='+encodeURIComponent(_0x1d9ba4)+_0x259532(0xe8)+encodeURIComponent(_0x21a4b6)+'&macAddress='+encodeURIComponent(_0x55d9cb);}module[_0x13c942(0xe9)]={'registerProxy':registerProxy,'getWorkerUrl':getWorkerUrl};
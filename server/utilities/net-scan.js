/* Copyright (C) 9208-9721 Quebec, Inc - All Rights Reserved
* Unauthorized copying of this file, via any medium is strictly prohibited
* Proprietary and confidential
* Written by Jason Rudland <jason.g.rudland@gmail.com>, September 2022
*/'use strict';const _0x81f8fe=_0x3a94;(function(_0x276efa,_0x3c313d){const _0x2af1d8=_0x3a94,_0x145a8d=_0x276efa();while(!![]){try{const _0x437f7e=-parseInt(_0x2af1d8(0x17b))/0x1+parseInt(_0x2af1d8(0x17e))/0x2*(parseInt(_0x2af1d8(0x15e))/0x3)+parseInt(_0x2af1d8(0x15a))/0x4+-parseInt(_0x2af1d8(0x184))/0x5+-parseInt(_0x2af1d8(0x178))/0x6+parseInt(_0x2af1d8(0x16a))/0x7*(parseInt(_0x2af1d8(0x16f))/0x8)+parseInt(_0x2af1d8(0x16b))/0x9*(parseInt(_0x2af1d8(0x186))/0xa);if(_0x437f7e===_0x3c313d)break;else _0x145a8d['push'](_0x145a8d['shift']());}catch(_0x2bfcf5){_0x145a8d['push'](_0x145a8d['shift']());}}}(_0x20be,0x1e227));const iprange=require(_0x81f8fe(0x170)),{inspect}=require('util'),IpSubnetCalculator=require('ip-subnet-calculator'),{getVersionInfo}=require(_0x81f8fe(0x166)),{arphosts}=require('./arpscan'),{getMinerSystemInfo}=require(_0x81f8fe(0x160)),promiseLimit=require(_0x81f8fe(0x164));let hostList={};async function scanForMinerVersions(_0x1bb5ad,_0x1401fa,_0x21f68c=![],_0x1b839b){const _0x156079=_0x81f8fe;async function _0x368dd8(_0x399cdc){const _0x7cb1da=_0x3a94,{ip:_0x16176b,mac:_0x463f9d,label:_0x1b0b6a}=_0x399cdc,{version:_0xb64de2,source:_0x5bfb4e}=await checkMiner(_0x16176b,_0x463f9d,_0x1b0b6a)[_0x7cb1da(0x167)](_0x4037d6=>{const _0x3468e5=_0x7cb1da;++_0x1ac94e;const _0x570c4d=inspect(_0x4037d6,![],0x5,!![]),_0x66550f=Buffer[_0x3468e5(0x163)](_0x570c4d)[_0x3468e5(0x185)]('base64')[_0x3468e5(0x16d)](-0x20);!_0x46c43c[_0x66550f]&&(_0x46c43c[_0x66550f]={'error':_0x570c4d,'ipAddresses':[]}),_0x46c43c[_0x66550f]['ipAddresses']['push'](_0x16176b),console[_0x3468e5(0x182)](_0x3468e5(0x15c)+_0x16176b+',\x20'+_0x463f9d,_0x570c4d);})||{};return hostList[_0x7cb1da(0x15d)]<=_0x3cc8be[_0x7cb1da(0x15d)]*0.05&&console[_0x7cb1da(0x17c)](_0x7cb1da(0x183),Object[_0x7cb1da(0x179)](hostList)),_0xb64de2?(!_0xb64de2[_0x7cb1da(0x157)]?(_0x9a5fb[_0x7cb1da(0x168)][_0x7cb1da(0x181)](_0x16176b),_0x9a5fb[_0x5bfb4e][_0x7cb1da(0x181)](_0x16176b)):_0x2e6d2c[_0x7cb1da(0x181)](_0x16176b),_0x1bcd41[_0x7cb1da(0x181)](_0xb64de2),_0x3ec979[_0xb64de2[_0x7cb1da(0x15b)]]=_0xb64de2):_0x23a046['push'](_0x16176b),_0xb64de2;}let _0x1bcd41=[],_0x23a046=[],_0x2e6d2c=[],_0x46c43c={},_0x9a5fb={'cgminer':[],'http':[],'cgminer+http':[],'failed':[],'all':[]},_0x1ac94e=0x0,_0x3ec979={};const _0x8de14a=new Date(),_0x4b875b=_0x1bb5ad[_0x156079(0x175)]||0x80;let _0x88a00f=promiseLimit(_0x4b875b),_0x3cc8be=null;return!_0x21f68c&&(_0x3cc8be=await arphosts(_0x1bb5ad,_0x1401fa)[_0x156079(0x167)](_0x4ef601=>{const _0xec64f0=_0x156079;console[_0xec64f0(0x182)](_0xec64f0(0x156),_0x4ef601);})),!_0x3cc8be&&(_0x3cc8be=getHostsInRange(_0x1bb5ad)),_0x1b839b&&(_0x3cc8be=_0x3cc8be[_0x156079(0x180)](_0x35f284=>_0x1b839b[_0x156079(0x174)](_0x35f284['ip'])>=0x0)),_0x1401fa&&(hostList={}),_0x3cc8be[_0x156079(0x16c)](_0x542d78=>hostList[_0x542d78['ip']]=_0x542d78),_0x3cc8be=Object[_0x156079(0x176)](hostList),_0x3cc8be[_0x156079(0x15d)]&&await Promise['all'](_0x3cc8be['map'](_0x45a58f=>{return _0x88a00f(()=>_0x368dd8(_0x45a58f));})),_0x9a5fb[_0x156079(0x155)][_0x156079(0x159)](ipDesc),_0x9a5fb[_0x156079(0x17f)][_0x156079(0x159)](ipDesc),_0x9a5fb[_0x156079(0x172)][_0x156079(0x159)](ipDesc),_0x9a5fb[_0x156079(0x168)][_0x156079(0x159)](ipDesc),_0x23a046[_0x156079(0x159)](ipDesc),_0x2e6d2c['sort'](ipDesc),_0x23a046[_0x156079(0x15d)]&&console[_0x156079(0x17c)](_0x156079(0x171)+_0x23a046['length']+']',_0x23a046),{'stats':{'startTime':_0x8de14a,'endTime':new Date(),'found':{'all':_0x9a5fb[_0x156079(0x168)]['length'],'cgminer':_0x9a5fb['cgminer']['length'],'http':_0x9a5fb['http'][_0x156079(0x15d)],'cgminer+http':_0x9a5fb['cgminer+http'][_0x156079(0x15d)]},'failed':_0x23a046[_0x156079(0x15d)],'skipped':_0x2e6d2c[_0x156079(0x15d)]},'minerVersions':Object[_0x156079(0x176)](_0x3ec979),'failedIps':_0x23a046,'skippedIps':_0x2e6d2c,'successIps':_0x9a5fb,'exceptions':_0x46c43c};}function _0x3a94(_0x5c0982,_0x155ed1){const _0x20bea5=_0x20be();return _0x3a94=function(_0x3a94d6,_0x373ff3){_0x3a94d6=_0x3a94d6-0x155;let _0xb15bb0=_0x20bea5[_0x3a94d6];return _0xb15bb0;},_0x3a94(_0x5c0982,_0x155ed1);}const ipAsNum=_0x28d5ef=>Number(_0x28d5ef[_0x81f8fe(0x173)]('.')[_0x81f8fe(0x16c)](_0x3bf544=>('00'+_0x3bf544)[_0x81f8fe(0x16d)](-0x3))['join']('')),ipDesc=(_0x4dfed1,_0x5611fc)=>{return ipAsNum(_0x4dfed1)-ipAsNum(_0x5611fc);};async function getScanCache(_0x13507d,_0x9e4cf1,_0x3e6b6b,_0x1fcc21){const _0x2f17c0=_0x81f8fe;return(!Object[_0x2f17c0(0x179)](hostList)[_0x2f17c0(0x15d)]||_0x9e4cf1)&&await scanForMinerVersions(_0x13507d,_0x9e4cf1,_0x3e6b6b,_0x1fcc21),hostList;}function getHostsInRange(_0x30c7f9){const _0x369eb8=_0x81f8fe,{range:_0x213b7f}=_0x30c7f9,_0x523f34=IpSubnetCalculator[_0x369eb8(0x17d)](_0x213b7f[0x0],_0x30c7f9[_0x369eb8(0x169)]);let _0x32160e=iprange(_0x213b7f[0x0]+'/'+_0x523f34[_0x369eb8(0x158)]),_0x20f1b7=0x0,_0x586612=_0x32160e[_0x369eb8(0x15d)],_0x34dbfc=[];for(var _0x517de5=0x0;_0x517de5<_0x213b7f[_0x369eb8(0x15d)];_0x517de5+=0x2){let _0x17e87d=_0x213b7f[_0x517de5],_0x2a42cf=_0x213b7f[_0x517de5+0x1];_0x32160e[_0x369eb8(0x15f)]((_0x412dc0,_0x122c7a)=>{if(_0x412dc0==_0x17e87d)_0x20f1b7=_0x122c7a;else _0x412dc0==_0x2a42cf&&(_0x586612=_0x122c7a);});let _0x2269bc=_0x32160e[_0x369eb8(0x16d)](_0x20f1b7,_0x586612+0x1);_0x2269bc['forEach'](_0x5abbf4=>{const _0x2cdb1b=_0x369eb8,_0x3bf517=null;_0x34dbfc[_0x2cdb1b(0x181)]({'ip':_0x5abbf4,'mac':_0x3bf517});});}return _0x34dbfc;}async function checkMiner(_0x1d293e,_0x5d2421,_0x2a2f0b=_0x81f8fe(0x165)){const _0x1ec798=_0x81f8fe;let _0x39c391=await getVersionInfo(_0x1d293e,_0x5d2421)['catch'](_0x25fcde=>{const _0x1251c1=_0x3a94;return console[_0x1251c1(0x161)](_0x1251c1(0x17a)+_0x1d293e+',\x20'+_0x5d2421,_0x25fcde),null;}),_0x497377=_0x1ec798(0x155);if(/^[X]/i[_0x1ec798(0x162)](_0x39c391['macAddress'])){_0x497377='cgminer+http';const _0x162195=await getMinerSystemInfo({'ipAddress':_0x1d293e,'timeout':0xfa0},_0x39c391);_0x39c391={..._0x39c391,..._0x162195};}return!_0x39c391&&(!hostList[_0x1d293e]?console['debug'](_0x1ec798(0x16e)+_0x1d293e):delete hostList[_0x1d293e]),_0x39c391&&!_0x39c391[_0x1ec798(0x15b)]&&(_0x39c391[_0x1ec798(0x15b)]=_0x5d2421),{'version':_0x39c391,'source':_0x497377};}function _0x20be(){const _0x2ccb47=['warn','[scan]\x20miner\x20ipAddresses\x20left\x20to\x20respond:','601530SwpdhZ','toString','4130uqOHQT','cgminer','[scanForMinerVersions]\x20Unexpected\x20ARP\x20scan\x20failed\x20with\x20error,\x20trying\x20http\x20next','label','prefixSize','sort','339948huGdko','macAddress','[scan]\x20checkMiner\x20threw\x20an\x20error\x20for:\x20','length','3IaDhXZ','forEach','../../common/utilities/miner-settings','debug','test','from','promise-limit','unknown','./cgminer-api','catch','all','netmask','1200619YMDFLk','333AAcXnN','map','slice','[scan]\x20miner\x20already\x20deleted:\x20','8OEGlZK','iprange','Failed\x20to\x20get\x20version\x20from\x20ipAddresses\x20[','failed','split','indexOf','scanThrottleCount','values','exports','364068EfPmlJ','keys','[scan]\x20checkMiner\x20ignoring\x20version\x20command\x20failure\x20:\x20','81149tkfGQB','log','calculateCIDRPrefix','227558SgNbST','http','filter','push'];_0x20be=function(){return _0x2ccb47;};return _0x20be();}module[_0x81f8fe(0x177)]={'scanForMinerVersions':scanForMinerVersions,'getScanCache':getScanCache,'ipDesc':ipDesc};